<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="[AWS][ECS] How to calculate CPU utilization from ECS endpoint?" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction / Summary" /><meta property="og:description" content="Introduction / Summary" /><link rel="canonical" href="https://shihtiy.com/posts/ECS-calculate-CPU-utilization-metadata-endpoing/" /><meta property="og:url" content="https://shihtiy.com/posts/ECS-calculate-CPU-utilization-metadata-endpoing/" /><meta property="og:site_name" content="Shih-Ting, Yuan" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-17T00:01:11+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[AWS][ECS] How to calculate CPU utilization from ECS endpoint?" /><meta name="twitter:site" content="@shihtiy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://shihtiy.com/posts/ECS-calculate-CPU-utilization-metadata-endpoing/"},"description":"Introduction / Summary","url":"https://shihtiy.com/posts/ECS-calculate-CPU-utilization-metadata-endpoing/","@type":"BlogPosting","headline":"[AWS][ECS] How to calculate CPU utilization from ECS endpoint?","dateModified":"2022-05-11T21:34:11+01:00","datePublished":"2022-04-17T00:01:11+01:00","@context":"https://schema.org"}</script><title>[AWS][ECS] How to calculate CPU utilization from ECS endpoint? | Shih-Ting, Yuan</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Shih-Ting, Yuan"><meta name="application-name" content="Shih-Ting, Yuan"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/VKndUsfW_400x400.jpg" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title mt-3"> <a href="/">Shih-Ting, Yuan</a>
</div>
<div class="site-subtitle font-italic">Things as they really are.</div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/shihtiy-tw" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/shihtiy" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/shih-ting-yuan/" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20%5B'shihtiy.tw','gmail.com'%5D.join('@')" aria-label="email"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> </a>
</div>
</div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[AWS][ECS] How to calculate CPU utilization from ECS endpoint?</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span>
</div></div><div id="main-wrapper">
<div id="main">
<div class="row">
<div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
<h1 data-toc-skip>[AWS][ECS] How to calculate CPU utilization from ECS endpoint?</h1>
<div class="post-meta text-muted">
<div> By <em> <a href="https://twitter.com/shihtiy" target="_blank" rel="noopener noreferrer">Shih-Ting, Yuan</a> </em>
</div>
<div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-04-17 00:01:11 +0100" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 17, 2022, 12:01 AM +0100">Apr 17</em> </span> <span> Updated <em class="timeago" date="2022-05-11 20:34:11 +0000 " data-toggle="tooltip" data-placement="bottom" title="Wed, May 11, 2022, 8:34 PM +0000">May 11</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="713 words"> <em>3 min</em> read</span>
</div></div>
</div>
<div class="post-content">
<h2 id="introduction--summary">Introduction / Summary<a href="#introduction--summary"><i class="fas fa-hashtag"></i></a>
</h2>
<p>This article will go though how to check and calculate the container CPU utilization from ECS metadata endpoint.</p>
<h2 id="scenario">Scenario<a href="#scenario"><i class="fas fa-hashtag"></i></a>
</h2>
<p>Sometimes people want to know how to calculate the performance usages of the containers. They can use sidecar container to retrieve the data from the metrics provided by the ECS metadata endpoint. Thus they can collect, calculate and export the performance metrics like CPU utilization.</p>
<h2 id="explanation">Explanation<a href="#explanation"><i class="fas fa-hashtag"></i></a>
</h2>
<h3 id="the-cpu-metrics-provided-by-ecs-metadata-endpoint">The CPU metrics provided by ECS metadata endpoint<a href="#the-cpu-metrics-provided-by-ecs-metadata-endpoint"><i class="fas fa-hashtag"></i></a>
</h3>
<p>The <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-metadata-endpoint-v4.html#task-metadata-endpoint-v4-paths" target="_blank" rel="noopener noreferrer">ECS metadata document </a> mentions the following metadata path regarding the resource usage of container/task:</p>
<ul>
<li>
<code class="language-plaintext highlighter-rouge">${ECS_CONTAINER_METADATA_URI_V4}/stats</code>: This path returns Docker stats for the specific container.</li>
<li>
<code class="language-plaintext highlighter-rouge">${ECS_CONTAINER_METADATA_URI_V4}/task/stats</code> : This path returns Docker stats for <strong>all</strong> of the containers associated with the task.</li>
</ul>
<p>By accessing the endpoint <code class="language-plaintext highlighter-rouge">${ECS_CONTAINER_METADATA_URI_V4}/stats</code> inside a container, we can see the following output about CPU statistic:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="k">${</span><span class="nv">ECS_CONTAINER_METADATA_URI_V4</span><span class="k">}</span>/stats | jq <span class="s1">'.cpu_stats'</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<div class="language-json highlighter-rouge">
<div class="code-header"> <span label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
<td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"cpu_usage"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"total_usage"</span><span class="p">:</span><span class="w"> </span><span class="mi">6854309182</span><span class="p">,</span><span class="w">
    </span><span class="nl">"percpu_usage"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="mi">3836064097</span><span class="p">,</span><span class="w">
      </span><span class="mi">3018245085</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"usage_in_kernelmode"</span><span class="p">:</span><span class="w"> </span><span class="mi">3510000000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"usage_in_usermode"</span><span class="p">:</span><span class="w"> </span><span class="mi">2790000000</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"system_cpu_usage"</span><span class="p">:</span><span class="w"> </span><span class="mi">1139128190000000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"online_cpus"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"throttling_data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"periods"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"throttled_periods"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"throttled_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td>
</tr></tbody></table></code></div>
</div>
<p>We can see another field called <code class="language-plaintext highlighter-rouge">precpu_stats</code>. The Docker API <a href="https://docs.docker.com/engine/api/v1.30/#operation/ContainerStats" target="_blank" rel="noopener noreferrer">ContainerStats</a> document mentioned that the <code class="language-plaintext highlighter-rouge">precpu_stats</code> is the CPU statistic of the <em>previous</em> read, and is used to calculate the CPU usage percentage. <code class="language-plaintext highlighter-rouge">precpu_stats</code> is different from the <code class="language-plaintext highlighter-rouge">cpu_stats</code> field.</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="k">${</span><span class="nv">ECS_CONTAINER_METADATA_URI_V4</span><span class="k">}</span>/stats | jq <span class="s1">'.precpu_stats'</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<div class="language-json highlighter-rouge">
<div class="code-header"> <span label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
<td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"cpu_usage"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"total_usage"</span><span class="p">:</span><span class="w"> </span><span class="mi">6854629990</span><span class="p">,</span><span class="w">
    </span><span class="nl">"percpu_usage"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="mi">3836187199</span><span class="p">,</span><span class="w">
      </span><span class="mi">3018442791</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"usage_in_kernelmode"</span><span class="p">:</span><span class="w"> </span><span class="mi">3510000000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"usage_in_usermode"</span><span class="p">:</span><span class="w"> </span><span class="mi">2790000000</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"system_cpu_usage"</span><span class="p">:</span><span class="w"> </span><span class="mi">1139150390000000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"online_cpus"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"throttling_data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"periods"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"throttled_periods"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"throttled_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="how-to-calculate-cpu-utilization">How to calculate CPU utilization?<a href="#how-to-calculate-cpu-utilization"><i class="fas fa-hashtag"></i></a>
</h3>
<p>As <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-metadata-endpoint-v4.html#task-metadata-endpoint-v4-paths" target="_blank" rel="noopener noreferrer">ECS metadata document </a> mentions that these data are retrieved via Docker API <a href="https://docs.docker.com/engine/api/v1.30/#operation/ContainerStats" target="_blank" rel="noopener noreferrer">ContainerStats</a> , we can see the Docker API <a href="https://docs.docker.com/engine/api/v1.30/#operation/ContainerStats" target="_blank" rel="noopener noreferrer">ContainerStats</a> document mention how to calculate the CPU uilization:</p>
<ul>
<li>cpu_delta = <code class="language-plaintext highlighter-rouge">cpu_stats.cpu_usage.total_usage - precpu_stats.cpu_usage.total_usage</code>
</li>
<li>system_cpu_delta = <code class="language-plaintext highlighter-rouge">cpu_stats.system_cpu_usage - precpu_stats.system_cpu_usage</code>
</li>
<li>number_cpus = <code class="language-plaintext highlighter-rouge">lenght(cpu_stats.cpu_usage.percpu_usage)</code> or <code class="language-plaintext highlighter-rouge">cpu_stats.online_cpus</code>
</li>
<li>CPU usage % = <code class="language-plaintext highlighter-rouge">(cpu_delta / system_cpu_delta) * number_cpus * 100.0</code>
</li>
</ul>
<p>With the example above, we can then calculate the average CPU utilization:</p>
<ul>
<li>cpu_delta = cpu_stats.cpu_usage.total_usage - precpu_stats.cpu_usage.total_usage<ul><li>cpu_delta = 6854309182 - 6854629990</li></ul>
</li>
<li>system_cpu_delta = cpu_stats.system_cpu_usage - precpu_stats.system_cpu_usage<ul><li>system_cpu_delta = 1139128190000000 - 1139150390000000</li></ul>
</li>
<li>number_cpus = lenght(cpu_stats.cpu_usage.percpu_usage) or cpu_stats.online_cpus<ul><li>number_cpus = 2</li></ul>
</li>
<li>CPU usage % = (cpu_delta / system_cpu_delta) * number_cpus * 100.0<ul><li>CPU usage % = (6854309182 - 6854629990) / (1139128190000000 - 1139150390000000) * 2 * 100</li></ul>
</li>
</ul>
<h3 id="is-system_cpu_usage-considered-as-shared-or-separated-for-the-containers-">Is <code class="language-plaintext highlighter-rouge">system_cpu_usage</code> considered as “shared” or “separated” for the containers ?<a href="#is-system_cpu_usage-considered-as-shared-or-separated-for-the-containers-"><i class="fas fa-hashtag"></i></a>
</h3>
<p>Some people are wondering if the <code class="language-plaintext highlighter-rouge">system_cpu_usage</code> is the same for each container stat output or the metrics is different for each container. For this question, we can check the related code, I can see that the <code class="language-plaintext highlighter-rouge">system_cpu_usage</code> is system-level:</p>
<ol><li>Find the <code class="language-plaintext highlighter-rouge">system_cpu_usage</code>: <a href="https://github.com/moby/moby/blob/7b9275c0da707b030e62c96b679a976f31f929d3/api/types/stats.go" target="_blank" rel="noopener noreferrer">code</a>
</li></ol>
<div class="language-go highlighter-rouge">
<div class="code-header"> <span label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="c">// System Usage. Linux only.</span>

<span class="n">SystemUsage</span> <span class="kt">uint64</span> <span class="s">`json:"system_cpu_usage,omitempty"`</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<ol><li>Find that <code class="language-plaintext highlighter-rouge">getSystemCPUUsage</code> will return the CPU usage: <a href="https://github.com/moby/moby/blob/2773f81aa5e9e34733675a7aa7e4219391caccb0/daemon/stats/collector.go#L121" target="_blank" rel="noopener noreferrer">code</a>
</li></ol>
<div class="language-go highlighter-rouge">
<div class="code-header"> <span label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="c">// Sample system CPU usage close to container usage to avoid</span>
<span class="c">// noise in metric calculations.</span>
<span class="n">systemUsage</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">getSystemCPUUsage</span><span class="p">()</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">logrus</span><span class="o">.</span><span class="n">WithError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">WithField</span><span class="p">(</span><span class="s">"container_id"</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"collecting system cpu usage"</span><span class="p">)</span>
  <span class="k">continue</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<ol><li>Confirm the system CPU usage is retrieved from <code class="language-plaintext highlighter-rouge">/proc/stat</code>: <a href="https://github.com/moby/moby/blob/2773f81aa5e9e34733675a7aa7e4219391caccb0/daemon/stats/collector_unix.go#L31" target="_blank" rel="noopener noreferrer">code</a>
</li></ol>
<div class="language-go highlighter-rouge">
<div class="code-header"> <span label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">Collector</span><span class="p">)</span> <span class="n">getSystemCPUUsage</span><span class="p">()</span> <span class="p">(</span><span class="kt">uint64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"/proc/stat"</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<ol><li>
<code class="language-plaintext highlighter-rouge">/proc/stat</code> is kernel/system-wise static: <a href="https://man7.org/linux/man-pages/man5/proc.5.html" target="_blank" rel="noopener noreferrer">proc(5) - Linux manual page</a>
</li></ol>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="o">[</span>root@ip-172-31-83-85 ~]# <span class="nb">cat</span> /proc/stat
cpu  1858672 145 937683 147711096 42100 0 8871 790 0 0
cpu0 948377 51 470796 73832328 20560 0 5919 200 0 0
cpu1 910294 94 466886 73878768 21539 0 2951 589 0 0
</pre></td>
</tr></tbody></table></code></div>
</div>
<ol><li>Confirm that <code class="language-plaintext highlighter-rouge">system_cpu_usage</code> is the same for both containers in the same task by accessing <code class="language-plaintext highlighter-rouge">${ECS_CONTAINER_METADATA_URI_V4}/task/stats</code>:</li></ol>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="k">${</span><span class="nv">ECS_CONTAINER_METADATA_URI_V4</span><span class="k">}</span>/task/stats

  <span class="s2">"5f71e2b846442b1cc146d399135f490fdbbb5f3936b38119ffcf3c5d85308ac5"</span>: <span class="o">{</span>
    <span class="s2">"cpu_stats"</span>: <span class="o">{</span>
...
      <span class="s2">"system_cpu_usage"</span>: 1478570440000000,
...
  <span class="s2">"b0f919cbff4c787ae765cbcc8b094d4375bdb002848d78e9e635356bd94d8484"</span>: <span class="o">{</span>
    <span class="s2">"cpu_stats"</span>: <span class="o">{</span>
...
      <span class="s2">"system_cpu_usage"</span>: 1478570450000000,
...
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>We can see <code class="language-plaintext highlighter-rouge">system_cpu_usage</code> is the system-level metrics and this metric will be the same for both containers.</p>
<h2 id="summary">Summary<a href="#summary"><i class="fas fa-hashtag"></i></a>
</h2>
<p>ECS metadata endpoint provides metrics of container resources so people have the flexibility to collect, calculate the container performance by their own application or other third-party application like datadog.</p>
<p>We can also see that if we want to know deeper about the metrics, we can dig into the code and find the metrics resources to get more insight about the metrics.</p>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/csie/">CSIE</a>, <a href="/categories/aws/">AWS</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ecs/" class="post-tag no-text-decoration">ecs</a> <a href="/tags/cpu/" class="post-tag no-text-decoration">cpu</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer"> CC BY 4.0 </a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%5BAWS%5D%5BECS%5D%20How%20to%20calculate%20CPU%20utilization%20from%20ECS%20endpoint?%20-%20Shih-Ting,%20Yuan&amp;url=https://shihtiy.com/posts/ECS-calculate-CPU-utilization-metadata-endpoing/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener noreferrer" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%5BAWS%5D%5BECS%5D%20How%20to%20calculate%20CPU%20utilization%20from%20ECS%20endpoint?%20-%20Shih-Ting,%20Yuan&amp;u=https://shihtiy.com/posts/ECS-calculate-CPU-utilization-metadata-endpoing/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener noreferrer" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://shihtiy.com/posts/ECS-calculate-CPU-utilization-metadata-endpoing/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener noreferrer" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="https://telegram.me/share?text=%5BAWS%5D%5BECS%5D%20How%20to%20calculate%20CPU%20utilization%20from%20ECS%20endpoint?%20-%20Shih-Ting,%20Yuan&amp;url=https://shihtiy.com/posts/ECS-calculate-CPU-utilization-metadata-endpoing/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener noreferrer" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">
<div class="access">
<div id="access-lastmod" class="post">
<div class="panel-heading">Recent Update</div>
<ul class="post-content pl-0 pb-1 ml-1 mt-2">
<li><a href="/posts/too-long-for-Unix-domain-socket/">[Linux] Why do I run into '...too long for Unix domain socket' when git clone with SSH?</a></li>
<li><a href="/posts/max-open-file-limit-for-system-service/">[Linux] Max open file limit with system service</a></li>
<li><a href="/posts/NFS-Client-Port-Range/">[Linux] Port range for NFS client</a></li>
<li><a href="/posts/CLB-Scaling-in-AZ/">[AWS][CLB] Which AZ will CLB scale?</a></li>
<li><a href="/posts/ECS-calculate-CPU-utilization-metadata-endpoing/">[AWS][ECS] How to calculate CPU utilization from ECS endpoint?</a></li>
</ul>
</div>
<div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ecs/">ecs</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/cpu/">cpu</a> <a class="post-tag" href="/tags/clb/">clb</a> <a class="post-tag" href="/tags/elb/">elb</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/ip/">ip</a> <a class="post-tag" href="/tags/memory/">memory</a>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5">
<div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
<nav id="toc" data-toggle="toc"></nav>
</div>
</div>
</div>
<div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
<div id="related-posts" class="mt-5 mb-2 mb-sm-4">
<h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/posts/ECS-CPU-Memory/"><div class="card-body"> <em class="timeago small" date="2022-05-08 01:06:00 +0100">May 8</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[AWS][ECS] What I learned about CPU and memory management of Amazon ECS</h3>
<div class="text-muted small"><p> Introduction This article will go through what I learned from How Amazon ECS manages CPU and memory resources and few things I add about the CPU and memory management of Amazon ECS. Two General R...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/Difference-storage_states-and-blkio_stats/"><div class="card-body"> <em class="timeago small" date="2022-04-19 00:30:00 +0100">Apr 19</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[AWS][ECS] Difference between storage_stats and blkio_stats from ECS metadata endpoint</h3>
<div class="text-muted small"><p> Introduction / Summary This article will go though a brief explanation that why storage_stats and blkio_stats have different output from ECS metadata endpoint. Scenario Some people will question...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/CLB-Scaling-in-AZ/"><div class="card-body"> <em class="timeago small" date="2022-01-02 17:20:24 +0000">Jan 2</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[AWS][CLB] Which AZ will CLB scale?</h3>
<div class="text-muted small"><p> Introduction When under the following conditions: CLB enables multiple AZs. Cross-zone load balancing is disabled. Healthy backend instances only locate in one of the AZs. CLB DNS only r...</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/posts/CLB-Scaling-in-AZ/" class="btn btn-outline-primary" prompt="Older"><p>[AWS][CLB] Which AZ will CLB scale?</p></a> <a href="/posts/Difference-storage_states-and-blkio_stats/" class="btn btn-outline-primary" prompt="Newer"><p>[AWS][ECS] Difference between storage_stats and blkio_stats from ECS metadata endpoint</p></a>
</div>
<div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/" target="_blank" rel="noopener noreferrer">Disqus</a>.</p></div>
<script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://shihtiy.com/posts/ECS-calculate-CPU-utilization-metadata-endpoing/'; this.page.identifier = '/posts/ECS-calculate-CPU-utilization-metadata-endpoing/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://shihtiy.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script>
</div></div></div>
<footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted">
<div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/shihtiy" target="_blank" rel="noopener noreferrer">Shih-Ting, Yuan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div>
<div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener noreferrer">Chirpy</a> theme.</p></div>
</div></footer>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content">
<div id="search-hints"><div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ecs/">ecs</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/cpu/">cpu</a> <a class="post-tag" href="/tags/clb/">clb</a> <a class="post-tag" href="/tags/elb/">elb</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/ip/">ip</a> <a class="post-tag" href="/tags/memory/">memory</a>
</div>
</div></div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-1HNJH4QWWY"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-1HNJH4QWWY'); }); </script>
