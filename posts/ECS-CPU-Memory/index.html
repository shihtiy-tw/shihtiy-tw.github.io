<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="[AWS][ECS] What I learned about CPU and memory management of Amazon ECS" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://shihtiy.com/posts/ECS-CPU-Memory/" /><meta property="og:url" content="https://shihtiy.com/posts/ECS-CPU-Memory/" /><meta property="og:site_name" content="Shih-Ting, Yuan" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-08T01:06:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[AWS][ECS] What I learned about CPU and memory management of Amazon ECS" /><meta name="twitter:site" content="@shihtiy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://shihtiy.com/posts/ECS-CPU-Memory/"},"description":"Introduction","url":"https://shihtiy.com/posts/ECS-CPU-Memory/","@type":"BlogPosting","headline":"[AWS][ECS] What I learned about CPU and memory management of Amazon ECS","dateModified":"2022-05-11T21:34:11+01:00","datePublished":"2022-05-08T01:06:00+01:00","@context":"https://schema.org"}</script><title>[AWS][ECS] What I learned about CPU and memory management of Amazon ECS | Shih-Ting, Yuan</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Shih-Ting, Yuan"><meta name="application-name" content="Shih-Ting, Yuan"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/VKndUsfW_400x400.jpg" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title mt-3"> <a href="/">Shih-Ting, Yuan</a>
</div>
<div class="site-subtitle font-italic">Things as they really are.</div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/shihtiy-tw" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/shihtiy" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/shih-ting-yuan/" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20%5B'shihtiy.tw','gmail.com'%5D.join('@')" aria-label="email"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> </a>
</div>
</div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[AWS][ECS] What I learned about CPU and memory management of Amazon ECS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span>
</div></div><div id="main-wrapper">
<div id="main">
<div class="row">
<div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
<h1 data-toc-skip>[AWS][ECS] What I learned about CPU and memory management of Amazon ECS</h1>
<div class="post-meta text-muted">
<div> By <em> <a href="https://twitter.com/shihtiy" target="_blank" rel="noopener noreferrer">Shih-Ting, Yuan</a> </em>
</div>
<div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-05-08 01:06:00 +0100" data-toggle="tooltip" data-placement="bottom" title="Sun, May 8, 2022, 1:06 AM +0100">May 8</em> </span> <span> Updated <em class="timeago" date="2022-05-11 20:34:11 +0000 " data-toggle="tooltip" data-placement="bottom" title="Wed, May 11, 2022, 8:34 PM +0000">May 11</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2926 words"> <em>16 min</em> read</span>
</div></div>
</div>
<div class="post-content">
<h2 id="introduction">Introduction<a href="#introduction"><i class="fas fa-hashtag"></i></a>
</h2>
<p>This article will go through what I learned from <a href="https://aws.amazon.com/blogs/containers/how-amazon-ecs-manages-cpu-and-memory-resources/" target="_blank" rel="noopener noreferrer">How Amazon ECS manages CPU and memory resources</a> and few things I add about the CPU and memory management of Amazon ECS.</p>
<h2 id="two-general-rules">Two General Rules<a href="#two-general-rules"><i class="fas fa-hashtag"></i></a>
</h2>
<p>The blog<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> mentioned that there are two general rules of thumb with containers:</p>
<ul>
<li>unless otherwise restricted and capped, a container gets access to all the CPU and memory capacity available on a given host (operating system).</li>
<li>unless otherwise protected and guaranteed, all containers share CPU, memory, and other resources on a given host (operating system) in the same way that other processes running on that host share those resources.</li>
</ul>
<p>And we are going to talk about how the task and container access and share the CPU and memory resources with the related configuration defined in a task definition.</p>
<h2 id="memory">Memory<a href="#memory"><i class="fas fa-hashtag"></i></a>
</h2>
<p>For memory management, ECS provides the configuration of two levels:</p>
<ul>
<li>container-level: <code class="language-plaintext highlighter-rouge">memoryReservation</code> (soft limit) and <code class="language-plaintext highlighter-rouge">memory</code> (hard limit)</li>
<li>task-level: <code class="language-plaintext highlighter-rouge">memory</code> (hard limit)</li>
</ul>
<p>Let’s discuss what the differences, how these settings affect task scheduling and some scenarios of these different memory setting.</p>
<h3 id="container-level-memoryreservationsoft-limit-and-memoryhard-limit">Container-level: memoryReservation(soft limit) and memory(hard limit)<a href="#container-level-memoryreservationsoft-limit-and-memoryhard-limit"><i class="fas fa-hashtag"></i></a>
</h3>
<h4 id="memoryreservationsoft-limit">memoryReservation(soft limit)<a href="#memoryreservationsoft-limit"><i class="fas fa-hashtag"></i></a>
</h4>
<p><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html#container_definition_memory" target="_blank" rel="noopener noreferrer">The task definition document about memory setting</a> mentioned that <code class="language-plaintext highlighter-rouge">memoryReservation</code> is a soft limit (in MiB):</p>
<ul>
<li>This option indicates the memory size that a task needs on a container instance when being placed.</li>
<li>The sum of the <code class="language-plaintext highlighter-rouge">memoryReservation</code> of all containers in all the tasks running on a container instance, cannot exceed the available memory on that container instance.</li>
</ul>
<h4 id="memoryhard-limit">memory(hard limit)<a href="#memoryhard-limit"><i class="fas fa-hashtag"></i></a>
</h4>
<p><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html#container_definition_memory" target="_blank" rel="noopener noreferrer">The task definition document about memory setting</a> mentioned <code class="language-plaintext highlighter-rouge">memory</code> is the hard limit (in MiB) of the container:</p>
<ul>
<li>
<code class="language-plaintext highlighter-rouge">memory</code> is the upper bound that the memory usage a container cannot go beyond.</li>
<li>If the container exceed the <code class="language-plaintext highlighter-rouge">memory</code>, the container will be killed (by out-of-memory(OOM) killer of the Linux kernel which we will discuss later).</li>
</ul>
<h4 id="notes-for-memoryreservationsoft-limit-and-memoryhard-limit">Notes for memoryReservation(soft limit) and memory(hard limit)<a href="#notes-for-memoryreservationsoft-limit-and-memoryhard-limit"><i class="fas fa-hashtag"></i></a>
</h4>
<p>For the available memory of a container instance:</p>
<ul>
<li>If you specify <code class="language-plaintext highlighter-rouge">memoryReservation</code>, the available memory of a container instance will be subtracted by <code class="language-plaintext highlighter-rouge">memoryReservation</code>.</li>
<li>If you do not specify <code class="language-plaintext highlighter-rouge">memoryReservation</code>, the available memory of a container instance will be subtracted by <code class="language-plaintext highlighter-rouge">memory</code>.</li>
</ul>
<p>See below tables for the reservation and ceiling of the memory size a container can use:</p>
<div class="table-wrapper"><table>
<thead><tr>
<th>Configuration</th>
<th>Reservation</th>
<th>Ceiling</th>
</tr></thead>
<tbody>
<tr>
<td>
<code class="language-plaintext highlighter-rouge">memoryReservation</code> only</td>
<td><code class="language-plaintext highlighter-rouge">memoryReservation</code></td>
<td>total memory of the container instance or task memory size if configured</td>
</tr>
<tr>
<td>
<code class="language-plaintext highlighter-rouge">memoryReservation</code> <strong>and</strong> <code class="language-plaintext highlighter-rouge">memory</code><br>(<code class="language-plaintext highlighter-rouge">memory</code> must be greater than <code class="language-plaintext highlighter-rouge">memoryReservation</code>)</td>
<td><code class="language-plaintext highlighter-rouge">memoryReservation</code></td>
<td><code class="language-plaintext highlighter-rouge">memory</code></td>
</tr>
<tr>
<td>
<code class="language-plaintext highlighter-rouge">memory</code> only</td>
<td><code class="language-plaintext highlighter-rouge">memory</code></td>
<td><code class="language-plaintext highlighter-rouge">memory</code></td>
</tr>
<tr>
<td>no <code class="language-plaintext highlighter-rouge">memoryReservation</code> <strong>nor</strong> <code class="language-plaintext highlighter-rouge">memory</code>
</td>
<td>none</td>
<td>task-level memory size (and task-level memory size has to be configured, see below note)</td>
</tr>
</tbody>
</table></div>
<p>note: If a task-level memory size is not specified, you must specify a non-zero integer for one or both of <code class="language-plaintext highlighter-rouge">memory</code> or <code class="language-plaintext highlighter-rouge">memoryReservation</code> in a container definition.</p>
<h3 id="out-of-memoryoom-killer">Out-Of-Memory(OOM) killer<a href="#out-of-memoryoom-killer"><i class="fas fa-hashtag"></i></a>
</h3>
<p>If a container exceed the <code class="language-plaintext highlighter-rouge">memory</code>(hard limit), the container will be killed by Out-Of-Memory(OOM) killer. OOM killer is a Linux kernel mechanism to make sure that the system still have enough memory to run.<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup></p>
<p>How the OOM killer choose the container to kill will not be discussed in this article. Nevertheless, the blog<sup id="fnref:1:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> does mention below:</p>
<blockquote><p>If something is above its soft limit, it’s more likely to be killed than something below its soft limit, but figuring out which process gets killed requires knowing all the other processes on the system and what they are doing with their memory as well.</p></blockquote>
<p>As we have discussed that the ceiling or hard limit can be the container-level <code class="language-plaintext highlighter-rouge">memory</code>, task-level memory size or the total memory of the container instance, the mechanisms behind these limits are different.</p>
<p>When the system has low memory and the OOM killer is triggered, we can see the below OOM messages from system logs:</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>[11111111.111111] Out of memory: Kill process 11111 (java) score 311 or sacrifice child
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>On the other hand, the container-level and task-level limit is implemented by Linux control groups(cgroup)<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> with which we can control the resources a process can utilised. If a container exceed the memory hard limit, we can see cgroup oom from the system logs:</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>[2222222.222222] Memory cgroup out of memory: Kill process 22222 (nginx) score 0 or sacrifice child
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>The OOM usually results in the container to be stopped with exited code 137.</p>
<p>We can take different actions based on if it is an OS-level OOM or a cgroup oom:</p>
<ul>
<li>For OS-level OOM, we can<ul>
<li>distribute the loading on different instances (like task placement)</li>
<li>configure task-level or container-level memory limit(hard limit)</li>
</ul>
</li>
<li>For cgroup OOM, we can<ul>
<li>increase the task-level or container-level memory limit(hard limit)</li>
<li>scale out the container to distribute the loading on more containers</li>
</ul>
</li>
</ul>
<h3 id="swap-space">Swap space<a href="#swap-space"><i class="fas fa-hashtag"></i></a>
</h3>
<p>To decreased the impact of low-memory issue, Linux has a mechanism called swap space to allow OS to swap the physical memory to disk to free up memory space to use.</p>
<p>Docker also provide the option to allow container to use swap<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup> and ECS introduce the parameter to configure swap space for each container<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup>. In this way, even the container may hit the hard limit, the container can use swap space to avoid triggering OOM killer.</p>
<p>The blog<sup id="fnref:1:2" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> mention below:</p>
<blockquote><p>While swap config allows the container to swap if configured properly, it does not include accounting for swap usage in the scheduling phase; swap is not treated as a resource for the ECS scheduler. … While the OOM behavior isn’t changing, now containers can be configured to swap out to disk in a memory pressure scenario. This can potentially alleviate the need for the OOM killer to kick in (if containers are configured to swap).</p></blockquote>
<h3 id="task-level-memory-limit-hard-limit">Task-level: memory limit (hard limit)<a href="#task-level-memory-limit-hard-limit"><i class="fas fa-hashtag"></i></a>
</h3>
<p>We already mentioned that we can configure the task memory size and if the total memory usage of the containers within the task exceed the task memory size, OOM killer will be triggered.</p>
<p>When configuring the container-level and task-level memory, we will have the following notices as mentioned by the blog<sup id="fnref:1:3" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> :</p>
<ul>
<li>none of the containers can have a memory hard limit that exceeds the memory size of the task</li>
<li>the sum of all hard limits can exceed task-level memory size</li>
<li>the sum of all soft limits cannot exceed task-level memory size</li>
</ul>
<h3 id="scenarios-for-different-memory-configurations">Scenarios for different memory configurations<a href="#scenarios-for-different-memory-configurations"><i class="fas fa-hashtag"></i></a>
</h3>
<p>With the information above, let’s assume the following situations happen in your environment.</p>
<ul>
<li>The task size for memory is 512MB.</li>
<li>Container memory configuration:</li>
</ul>
<div class="table-wrapper"><table>
<thead><tr>
<th style="text-align: center">Container</th>
<th style="text-align: center">Hard limit</th>
<th style="text-align: center">Essential container</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align: center">A</td>
<td style="text-align: center">300 MB</td>
<td style="text-align: center">Yes</td>
</tr>
<tr>
<td style="text-align: center">B</td>
<td style="text-align: center">300 MB</td>
<td style="text-align: center">No</td>
</tr>
</tbody>
</table></div>
<blockquote class="prompt-info"><p>If the <code class="language-plaintext highlighter-rouge">essential</code> parameter of a container is marked as <code class="language-plaintext highlighter-rouge">true</code>, and that container fails or stops for any reason, all other containers that are part of the task are stopped.<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">6</a></sup></p></blockquote>
<h4 id="scenario-1">Scenario 1:<a href="#scenario-1"><i class="fas fa-hashtag"></i></a>
</h4>
<ul>
<li>Container A reach hard limit</li>
<li>The total memory usage for container A and B do not reach the task size for memory.</li>
</ul>
<p>The container A will be killed by OOM, and the task will be stopped.</p>
<h4 id="scenario-2">Scenario 2<a href="#scenario-2"><i class="fas fa-hashtag"></i></a>
</h4>
<ul>
<li>Container B reach hard limit</li>
<li>The total memory usage for container A and B do not reach the task size for memory.</li>
</ul>
<p>The container B will be killed by OOM, and the task will not be stopped.</p>
<h4 id="scenario-3">Scenario 3:<a href="#scenario-3"><i class="fas fa-hashtag"></i></a>
</h4>
<ul>
<li>Container A and B does not reach hard limit</li>
<li>The task size for memory usage has been reached.</li>
</ul>
<p>It may result in container A or B to be stopped by OOM, depending on which process in container A or B has the highest OOM score.</p>
<p>Of course, if the stopped container is Container A, as Container A is an essential container, the task will be stopped correspondingly.</p>
<h2 id="cpu">CPU<a href="#cpu"><i class="fas fa-hashtag"></i></a>
</h2>
<p>ECS also provide different levels of CPU usage: container-level and task-level. And the mechanism is different from how the memory limit works.</p>
<h3 id="vcpu-and-cpu-unit">vCPU and CPU unit<a href="#vcpu-and-cpu-unit"><i class="fas fa-hashtag"></i></a>
</h3>
<p>ECS introduce an abstract term call CPU unit. The blog<sup id="fnref:1:4" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> mentions below:</p>
<blockquote><p>“CPU units” is just an ECS construct and it doesn’t exist in the world of the Linux kernel…. As a baseline ECS considers each vCPU available to an EC2 container instance as 1024 units. That is, an EC2 host that has 8 vCPUs has 8×1024=8192 units available.</p></blockquote>
<h3 id="container-level-a-relative-share">Container-level: a relative share<a href="#container-level-a-relative-share"><i class="fas fa-hashtag"></i></a>
</h3>
<p>The container-level CPU limit acts as a relative share or weight: Take the example from the blog<sup id="fnref:1:5" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> :</p>
<p>A task running on a host with 8192 CPU units has two containers:</p>
<ul>
<li>containerA: assigned with 512 units</li>
<li>containerB: assigned with 1024 units</li>
</ul>
<p>When both containers are busy and under high loading, they can access the rest CPU time (8192-512-1024=6656 CPU units). The rest of CPU time will be shared as:</p>
<ul>
<li>containerA can get access to 1/3 of 6656 = 2219 CPU units</li>
<li>containerB can get access to 2/3 of 6656= 4437 CPU units</li>
</ul>
<p>The blog<sup id="fnref:1:6" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> describe the following regarding CPU usages:</p>
<ul>
<li>if containers are not using their allotted CPU units, other containers can use that capacity. When capacity is not used, any container can burst to use that spare capacity.</li>
<li>CPU shares control the amount of CPU capacity available when there is CPU contention; that is, multiple containers attempting to use the CPU at the same time.</li>
</ul>
<blockquote class="prompt-info"><p>When you don’t specify any CPU units for a container, ECS intrinsically enforces two Linux CPU shares(which we will discuss later below) for the cgroup (which is the minimum allowed).</p></blockquote>
<h3 id="task-level-hard-limit">Task-level: hard limit<a href="#task-level-hard-limit"><i class="fas fa-hashtag"></i></a>
</h3>
<p>The task-level CPU setting is different from container-level CPU setting. The task-level CPU setting is an upper bound of the CPU limit the containers can use.</p>
<p>If the container exceeds the task-level CPU limit, the container will not be killed like a container will be killed by OOM when exceeding memory hard limit.</p>
<h3 id="scenarios-for-different-cpu-configurations">Scenarios for different CPU configurations<a href="#scenarios-for-different-cpu-configurations"><i class="fas fa-hashtag"></i></a>
</h3>
<p>We can do the following test on a container with 2 vCPUs with and without task-level and different container-level CPU limit to see how it will turn out.</p>
<h4 id="scenario-1-without-task-level-cpu-limit">Scenario 1: Without task-level CPU limit<a href="#scenario-1-without-task-level-cpu-limit"><i class="fas fa-hashtag"></i></a>
</h4>
<p>There are two containers with the container-level setting: 256 CPU units and 512 CPU units. We can see that the total CPU utilisation is two vCPU and the CPU shared is based on the ratio of the container-level CPU setting:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>docker stats
CONTAINER ID        NAME                                                        CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS
5cdf7ea5edf7        ecs-agent                                                   0.06%               14.91MiB / 7.544GiB   0.19%               0B / 0B             0B / 0B             13
391f208f0606        ecs-stressWithoutTaskCpu-5-stress256-848ebdebcea0ebe8aa01   66.57%              956KiB / 7.544GiB     0.01%               836B / 0B           0B / 0B             3
c73331a916f3        ecs-stressWithoutTaskCpu-5-stress512-86bbd0e094d6e6cdb801   131.23%             880KiB / 7.544GiB     0.01%               836B / 0B           0B / 0B             3
</pre></td>
</tr></tbody></table></code></div>
</div>
<h4 id="scenario-2-with-task-level-cpu-setting-1024-cpu-units">Scenario 2: With task-level CPU setting: 1024 CPU units<a href="#scenario-2-with-task-level-cpu-setting-1024-cpu-units"><i class="fas fa-hashtag"></i></a>
</h4>
<p>There are two containers with the container-level setting: 256 CPU units and 512 CPU units. We can see that the total CPU utilisation is one vCPU and the CPU shared is based on the ratio of the container-level CPU setting:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>docker stats
CONTAINER ID        NAME                                                     CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS
5cdf7ea5edf7        ecs-agent                                                0.00%               14.92MiB / 7.544GiB   0.19%               0B / 0B             0B / 0B             13
20bc598752c7        ecs-stressWithTaskCpu-2-stress512-98b3befeffe68196de01   67.19%              832KiB / 7.544GiB     0.01%               906B / 0B           0B / 0B             3
487ef173aca2        ecs-stressWithTaskCpu-2-stress256-bafab0898b96d5d3b701   33.52%              924KiB / 7.544GiB     0.01%               816B / 0B           0B / 0B             3
</pre></td>
</tr></tbody></table></code></div>
</div>
<h2 id="under-the-hood">Under the hood<a href="#under-the-hood"><i class="fas fa-hashtag"></i></a>
</h2>
<h3 id="memory-1">Memory<a href="#memory-1"><i class="fas fa-hashtag"></i></a>
</h3>
<p>As the container resource limit is implemented by cgroup, we can actually check the memory limit from host-level and check the cgroup configuration.</p>
<h4 id="cgroup-setting-for-memory">cgroup setting for memory<a href="#cgroup-setting-for-memory"><i class="fas fa-hashtag"></i></a>
</h4>
<p>From the cgroup document<sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">7</a></sup>, we can see that the following files regarding memory limit:</p>
<ul>
<li>
<code class="language-plaintext highlighter-rouge">memory.soft_limit_in_bytes</code>: set/show soft limit of memory usage</li>
<li>
<code class="language-plaintext highlighter-rouge">memory.limit_in_bytes</code>: set/show limit of memory usage</li>
</ul>
<p>Let’s have a ECS task <code class="language-plaintext highlighter-rouge">602081644df34fb5bf1c5786ef261fe7</code> which is configured to have 1024 MiB task-level memory setting and the container-level has 128MiB soft limit. We can find these memory limit from cgroup settings.</p>
<h4 id="task-level-memory-limit">Task-level memory limit<a href="#task-level-memory-limit"><i class="fas fa-hashtag"></i></a>
</h4>
<p>We can find a directory of cgroup match the task ID and we can see that the <code class="language-plaintext highlighter-rouge">memory.limit_in_bytes</code> is around 1024 MiB:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat</span> /sys/fs/cgroup/memory/ecs/602081644df34fb5bf1c5786ef261fe7/memory.limit_in_bytes
1073741824
</pre></td>
</tr></tbody></table></code></div>
</div>
<h4 id="container-level-memory-limit">Container-level memory limit<a href="#container-level-memory-limit"><i class="fas fa-hashtag"></i></a>
</h4>
<p>Under the directory of cgroup for the ECS task, we will find another directory the and directory name will match the container ID of the ECS task. We can further check the <code class="language-plaintext highlighter-rouge">memory.soft_limit_in_bytes</code> and see that the value is around 128 MiB. Since I didn’t set the container-level hard limit, we can see <code class="language-plaintext highlighter-rouge">memory.limit_in_bytes</code> is a very huge number:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="c"># soft limit 128 MB</span>
<span class="nv">$ </span><span class="nb">cat</span> /sys/fs/cgroup/memory/ecs/602081644df34fb5bf1c5786ef261fe7/2624b365b6ea72e9c9a9825038136f30c9721665c0e6394fabf29c6960edb593/memory.soft_limit_in_bytes
134217728

<span class="nv">$ </span><span class="nb">cat</span> /sys/fs/cgroup/memory/ecs/602081644df34fb5bf1c5786ef261fe7/2624b365b6ea72e9c9a9825038136f30c9721665c0e6394fabf29c6960edb593/memory.limit_in_bytes
9223372036854771712
</pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="cpu-1">CPU<a href="#cpu-1"><i class="fas fa-hashtag"></i></a>
</h3>
<h4 id="cgroup-setting-for-cpu">cgroup setting for CPU<a href="#cgroup-setting-for-cpu"><i class="fas fa-hashtag"></i></a>
</h4>
<p>cgroup setting for CPU has different concept from memory. RedHat document gives a detail description about the cgroup setting for CPU<sup id="fnref:8" role="doc-noteref"><a href="#fn:8" class="footnote" rel="footnote">8</a></sup>:</p>
<ul><li>
<code class="language-plaintext highlighter-rouge">cpu.shares</code> contains an integer value that specifies a ==relative share== of CPU time available to the tasks in a cgroup.</li></ul>
<blockquote><p>For example, tasks in two cgroups that have <code class="language-plaintext highlighter-rouge">cpu.shares</code> set to <code class="language-plaintext highlighter-rouge">100</code> will receive equal CPU time, but tasks in a cgroup that has <code class="language-plaintext highlighter-rouge">cpu.shares</code> set to <code class="language-plaintext highlighter-rouge">200</code> receive twice the CPU time of tasks in a cgroup where <code class="language-plaintext highlighter-rouge">cpu.shares</code> is set to <code class="language-plaintext highlighter-rouge">100</code>. The value specified in the <code class="language-plaintext highlighter-rouge">cpu.shares</code> file must be <code class="language-plaintext highlighter-rouge">2</code> or higher.</p></blockquote>
<ul>
<li>
<code class="language-plaintext highlighter-rouge">cpu.cfs_period_us</code> specifies a period of time in microseconds (<code class="language-plaintext highlighter-rouge">µs</code>, represented here as “us”) for how regularly a cgroup’s access to CPU resources should be reallocated.</li>
<li>
<code class="language-plaintext highlighter-rouge">cpu.cfs_quota_us</code> specifies the total amount of time in microseconds (µs, represented here as “us”) for which all tasks in a cgroup can run during one period (as defined by cpu.cfs_period_us).</li>
<li>
<code class="language-plaintext highlighter-rouge">nr_throttled</code>: number of times tasks in a cgroup have been throttled (that is, not allowed to run because they have exhausted all of the available time as specified by their quota).</li>
<li>
<code class="language-plaintext highlighter-rouge">throttled_time</code>: the total time duration (in nanoseconds) for which tasks in a cgroup have been throttled.</li>
</ul>
<h4 id="container-level-limit">Container-level limit<a href="#container-level-limit"><i class="fas fa-hashtag"></i></a>
</h4>
<p>Let’s have a container without any container-level CPU setting:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /sys/fs/cgroup/cpu/ecs/4ed351a8c26d47f0bb502c7019256bc7/5934355a9835e1ea5a70333ffbfeab6767ae046cdf05748b8083640f675f46db/
total 0
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cgroup.clone_children
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cgroup.procs
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.stat
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_all
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_percpu
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_percpu_sys
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_percpu_user
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_sys
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_user
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cpu.cfs_period_us
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cpu.cfs_quota_us
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cpu.rt_period_us
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cpu.rt_runtime_us
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cpu.shares
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpu.stat
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 notify_on_release
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 tasks

</pre></td>
</tr></tbody></table></code></div>
</div>
<p>We can see that the cpu.shares is the default value 2:</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre>$ cat /sys/fs/cgroup/cpu/ecs/4ed351a8c26d47f0bb502c7019256bc7/5934355a9835e1ea5a70333ffbfeab6767ae046cdf05748b8083640f675f46db/cpu.shares
2

</pre></td>
</tr></tbody></table></code></div>
</div>
<p><code class="language-plaintext highlighter-rouge">cpu.cfs_period_us</code> 100000 and <code class="language-plaintext highlighter-rouge">cpu.cfs_quota_us</code> -1 means that the container can access the CPU every 1 second and there is no restriction on accessing CPU<sup id="fnref:9" role="doc-noteref"><a href="#fn:9" class="footnote" rel="footnote">9</a></sup>. Since there is no hard-limit, there is no throttling happening:</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td>
<td class="rouge-code"><pre>$ cat /sys/fs/cgroup/cpu/ecs/4ed351a8c26d47f0bb502c7019256bc7/5934355a9835e1ea5a70333ffbfeab6767ae046cdf05748b8083640f675f46db/cpu.cfs_period_us
100000

$ cat /sys/fs/cgroup/cpu/ecs/4ed351a8c26d47f0bb502c7019256bc7/5934355a9835e1ea5a70333ffbfeab6767ae046cdf05748b8083640f675f46db/cpu.cfs_quota_us
-1

$ cat /sys/fs/cgroup/cpu/ecs/4ed351a8c26d47f0bb502c7019256bc7/5934355a9835e1ea5a70333ffbfeab6767ae046cdf05748b8083640f675f46db/cpu.stat
nr_periods 0
nr_throttled 0
throttled_time 0
</pre></td>
</tr></tbody></table></code></div>
</div>
<h4 id="task-level-limit">Task-level limit<a href="#task-level-limit"><i class="fas fa-hashtag"></i></a>
</h4>
<p>For example, I have an ECS task <code class="language-plaintext highlighter-rouge">a3d6aa8e76e540a0b48e9ac162c75adb</code> with task-level CPU setting 512 CPU units, I can check the CPU limit in the following path:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws ecs list-tasks <span class="nt">--cluster</span> ECS-Test | <span class="nb">grep </span>4ed
        <span class="s2">"arn:aws:ecs:us-east-1:111111111111:task/ECS-Test/4ed351a8c26d47f0bb502c7019256bc7"</span>,

<span class="nv">$ </span>docker ps
CONTAINER ID   IMAGE                            COMMAND              CREATED       STATUS                 PORTS                                     NAMES
5934355a9835   httpd                            <span class="s2">"httpd-foreground"</span>   13 days ago   Up 13 days             0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   ecs-apache-20-apache-a0d8c096ccc599997e00

<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /sys/fs/cgroup/cpu/ecs
total 0
drwxr-xr-x 3 root root 0 Apr 19 22:33 4ed351a8c26d47f0bb502c7019256bc7

<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /sys/fs/cgroup/cpu/ecs/4ed351a8c26d47f0bb502c7019256bc7/
total 0
drwxr-xr-x 2 root root 0 Apr 19 22:33 5934355a9835e1ea5a70333ffbfeab6767ae046cdf05748b8083640f675f46db
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cgroup.clone_children
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cgroup.procs
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.stat
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_all
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_percpu
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_percpu_sys
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_percpu_user
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_sys
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpuacct.usage_user
<span class="nt">-rw-r--r--</span> 1 root root 0 Apr 19 22:33 cpu.cfs_period_us
<span class="nt">-rw-r--r--</span> 1 root root 0 Apr 19 22:33 cpu.cfs_quota_us
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cpu.rt_period_us
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cpu.rt_runtime_us
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 cpu.shares
<span class="nt">-r--r--r--</span> 1 root root 0 May  3 21:39 cpu.stat
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 notify_on_release
<span class="nt">-rw-r--r--</span> 1 root root 0 May  3 21:39 tasks
</pre></td>
</tr></tbody></table></code></div>
</div>
<p><code class="language-plaintext highlighter-rouge">cpu.cfs_period_us</code> 100000 and <code class="language-plaintext highlighter-rouge">cpu.cfs_quota_us</code> 50000 means that the container can access the CPU for 0.5 second for every 1 second.</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre>$ cat /sys/fs/cgroup/cpu/ecs/4ed351a8c26d47f0bb502c7019256bc7/cpu.cfs_period_us
100000
$ cat /sys/fs/cgroup/cpu/ecs/4ed351a8c26d47f0bb502c7019256bc7/cpu.cfs_quota_us
50000
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>We can also see that the container has metrics indicating that throttling happened:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat</span> /sys/fs/cgroup/cpu/ecs/4ed351a8c26d47f0bb502c7019256bc7/cpu.stat
nr_periods 140596
nr_throttled 7
throttled_time 388807946
</pre></td>
</tr></tbody></table></code></div>
</div>
<h2 id="summary">Summary<a href="#summary"><i class="fas fa-hashtag"></i></a>
</h2>
<p>The AWS blog<sup id="fnref:1:7" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> does explain in detail about the memory and CPU management of Amazon ECS and I just organized in a way I understand the blog. Hope this article can give you a brief understanding about how Amazon ECS design and implement the management of memory and CPU management.</p>
<h2 id="references">References<a href="#references"><i class="fas fa-hashtag"></i></a>
</h2>
<div class="footnotes" role="doc-endnotes"><ol>
<li id="fn:1" role="doc-endnote"><p><a href="https://aws.amazon.com/blogs/containers/how-amazon-ecs-manages-cpu-and-memory-resources/" target="_blank" rel="noopener noreferrer">How Amazon ECS manages CPU and memory resources</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a> <a href="#fnref:1:1" class="reversefootnote" role="doc-backlink">↩<sup>2</sup></a> <a href="#fnref:1:2" class="reversefootnote" role="doc-backlink">↩<sup>3</sup></a> <a href="#fnref:1:3" class="reversefootnote" role="doc-backlink">↩<sup>4</sup></a> <a href="#fnref:1:4" class="reversefootnote" role="doc-backlink">↩<sup>5</sup></a> <a href="#fnref:1:5" class="reversefootnote" role="doc-backlink">↩<sup>6</sup></a> <a href="#fnref:1:6" class="reversefootnote" role="doc-backlink">↩<sup>7</sup></a> <a href="#fnref:1:7" class="reversefootnote" role="doc-backlink">↩<sup>8</sup></a></p></li>
<li id="fn:2" role="doc-endnote"><p><a href="https://www.kernel.org/doc/gorman/html/understand/understand016.html" target="_blank" rel="noopener noreferrer">Out Of Memory Management</a> <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p></li>
<li id="fn:3" role="doc-endnote"><p><a href="https://man7.org/linux/man-pages/man7/cgroups.7.html" target="_blank" rel="noopener noreferrer">cgroups(7) - Linux manual page</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">↩</a></p></li>
<li id="fn:4" role="doc-endnote"><p><a href="https://docs.docker.com/config/containers/resource_constraints/#--memory-swap-details" target="_blank" rel="noopener noreferrer">Runtime options with Memory, CPUs, and GPUs</a> <a href="#fnref:4" class="reversefootnote" role="doc-backlink">↩</a></p></li>
<li id="fn:5" role="doc-endnote"><p><a href="https://aws.amazon.com/about-aws/whats-new/2019/08/amazon-ecs-now-supports-per-container-swap-space-parameters/" target="_blank" rel="noopener noreferrer">Amazon ECS Now Supports Per-Container Swap Space Parameters</a> <a href="#fnref:5" class="reversefootnote" role="doc-backlink">↩</a></p></li>
<li id="fn:6" role="doc-endnote"><p><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html" target="_blank" rel="noopener noreferrer">Task definition parameters - Amazon Elastic Container Service</a> <a href="#fnref:6" class="reversefootnote" role="doc-backlink">↩</a></p></li>
<li id="fn:7" role="doc-endnote"><p><a href="https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt" target="_blank" rel="noopener noreferrer">https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt</a> <a href="#fnref:7" class="reversefootnote" role="doc-backlink">↩</a></p></li>
<li id="fn:8" role="doc-endnote"><p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-cpu" target="_blank" rel="noopener noreferrer">3.2. cpu Red Hat Enterprise Linux 6</a> <a href="#fnref:8" class="reversefootnote" role="doc-backlink">↩</a></p></li>
<li id="fn:9" role="doc-endnote"><p><a href="https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt" target="_blank" rel="noopener noreferrer">https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt</a> <a href="#fnref:9" class="reversefootnote" role="doc-backlink">↩</a></p></li>
</ol></div>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/csie/">CSIE</a>, <a href="/categories/cloud/">Cloud</a>, <a href="/categories/aws/">AWS</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration">aws</a> <a href="/tags/ecs/" class="post-tag no-text-decoration">ecs</a> <a href="/tags/memory/" class="post-tag no-text-decoration">memory</a> <a href="/tags/cpu/" class="post-tag no-text-decoration">cpu</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer"> CC BY 4.0 </a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%5BAWS%5D%5BECS%5D%20What%20I%20learned%20about%20CPU%20and%20memory%20management%20of%20Amazon%20ECS%20-%20Shih-Ting,%20Yuan&amp;url=https://shihtiy.com/posts/ECS-CPU-Memory/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener noreferrer" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%5BAWS%5D%5BECS%5D%20What%20I%20learned%20about%20CPU%20and%20memory%20management%20of%20Amazon%20ECS%20-%20Shih-Ting,%20Yuan&amp;u=https://shihtiy.com/posts/ECS-CPU-Memory/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener noreferrer" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://shihtiy.com/posts/ECS-CPU-Memory/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener noreferrer" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="https://telegram.me/share?text=%5BAWS%5D%5BECS%5D%20What%20I%20learned%20about%20CPU%20and%20memory%20management%20of%20Amazon%20ECS%20-%20Shih-Ting,%20Yuan&amp;url=https://shihtiy.com/posts/ECS-CPU-Memory/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener noreferrer" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">
<div class="access">
<div id="access-lastmod" class="post">
<div class="panel-heading">Recent Update</div>
<ul class="post-content pl-0 pb-1 ml-1 mt-2">
<li><a href="/posts/too-long-for-Unix-domain-socket/">[Linux] Why do I run into '...too long for Unix domain socket' when git clone with SSH?</a></li>
<li><a href="/posts/max-open-file-limit-for-system-service/">[Linux] Max open file limit with system service</a></li>
<li><a href="/posts/NFS-Client-Port-Range/">[Linux] Port range for NFS client</a></li>
<li><a href="/posts/CLB-Scaling-in-AZ/">[AWS][CLB] Which AZ will CLB scale?</a></li>
<li><a href="/posts/ECS-calculate-CPU-utilization-metadata-endpoing/">[AWS][ECS] How to calculate CPU utilization from ECS endpoint?</a></li>
</ul>
</div>
<div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ecs/">ecs</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/cpu/">cpu</a> <a class="post-tag" href="/tags/clb/">clb</a> <a class="post-tag" href="/tags/elb/">elb</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/ip/">ip</a> <a class="post-tag" href="/tags/memory/">memory</a>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5">
<div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
<nav id="toc" data-toggle="toc"></nav>
</div>
</div>
</div>
<div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
<div id="related-posts" class="mt-5 mb-2 mb-sm-4">
<h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/posts/ECS-calculate-CPU-utilization-metadata-endpoing/"><div class="card-body"> <em class="timeago small" date="2022-04-17 00:01:11 +0100">Apr 17</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[AWS][ECS] How to calculate CPU utilization from ECS endpoint?</h3>
<div class="text-muted small"><p> Introduction / Summary This article will go though how to check and calculate the container CPU utilization from ECS metadata endpoint. Scenario Sometimes people want to know how to calculate th...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/CLB-Scaling-in-AZ/"><div class="card-body"> <em class="timeago small" date="2022-01-02 17:20:24 +0000">Jan 2</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[AWS][CLB] Which AZ will CLB scale?</h3>
<div class="text-muted small"><p> Introduction When under the following conditions: CLB enables multiple AZs. Cross-zone load balancing is disabled. Healthy backend instances only locate in one of the AZs. CLB DNS only r...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/Difference-storage_states-and-blkio_stats/"><div class="card-body"> <em class="timeago small" date="2022-04-19 00:30:00 +0100">Apr 19</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[AWS][ECS] Difference between storage_stats and blkio_stats from ECS metadata endpoint</h3>
<div class="text-muted small"><p> Introduction / Summary This article will go though a brief explanation that why storage_stats and blkio_stats have different output from ECS metadata endpoint. Scenario Some people will question...</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/posts/Difference-storage_states-and-blkio_stats/" class="btn btn-outline-primary" prompt="Older"><p>[AWS][ECS] Difference between storage_stats and blkio_stats from ECS metadata endpoint</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span>
</div>
<div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/" target="_blank" rel="noopener noreferrer">Disqus</a>.</p></div>
<script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://shihtiy.com/posts/ECS-CPU-Memory/'; this.page.identifier = '/posts/ECS-CPU-Memory/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://shihtiy.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script>
</div></div></div>
<footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted">
<div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/shihtiy" target="_blank" rel="noopener noreferrer">Shih-Ting, Yuan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div>
<div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener noreferrer">Chirpy</a> theme.</p></div>
</div></footer>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content">
<div id="search-hints"><div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ecs/">ecs</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/cpu/">cpu</a> <a class="post-tag" href="/tags/clb/">clb</a> <a class="post-tag" href="/tags/elb/">elb</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/ip/">ip</a> <a class="post-tag" href="/tags/memory/">memory</a>
</div>
</div></div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-1HNJH4QWWY"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-1HNJH4QWWY'); }); </script>
